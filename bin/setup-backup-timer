#!/bin/bash
###############################################################################
# RPS Backup Timer Setup Script
#
# Installs and enables systemd timer for automated RPS backups
#
# Usage:
#   sudo ./bin/setup-backup-timer
#
# Author: pan
# Date: 2026-01-20
###############################################################################

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
SYSTEMD_USER_DIR="${HOME}/.config/systemd/user"
SYSTEMD_SYSTEM_DIR="/etc/systemd/system"

log() {
    local level=$1
    shift
    case $level in
        INFO) echo -e "${BLUE}[INFO]${NC} $*" ;;
        SUCCESS) echo -e "${GREEN}[SUCCESS]${NC} $*" ;;
        WARNING) echo -e "${YELLOW}[WARNING]${NC} $*" ;;
        ERROR) echo -e "${RED}[ERROR]${NC} $*" ;;
        *) echo "[$level] $*" ;;
    esac
}

# Check if running as root or has sudo
check_privileges() {
    if [[ $EUID -eq 0 ]]; then
        USE_SUDO=""
        INSTALL_TYPE="system"
    elif sudo -n true 2>/dev/null; then
        USE_SUDO="sudo"
        INSTALL_TYPE="system"
    else
        log WARNING "No sudo access, installing as user service"
        USE_SUDO=""
        INSTALL_TYPE="user"
    fi
}

# Install as system service (preferred)
install_system_service() {
    log INFO "Installing systemd timer as system service..."

    # Copy service and timer files
    $USE_SUDO cp "${PROJECT_ROOT}/systemd/rps-backup.service" "${SYSTEMD_SYSTEM_DIR}/"
    $USE_SUDO cp "${PROJECT_ROOT}/systemd/rps-backup.timer" "${SYSTEMD_SYSTEM_DIR}/"

    # Reload systemd
    $USE_SUDO systemctl daemon-reload

    # Enable and start timer
    $USE_SUDO systemctl enable rps-backup.timer
    $USE_SUDO systemctl start rps-backup.timer

    log SUCCESS "System timer installed and started"

    # Show status
    echo ""
    $USE_SUDO systemctl status rps-backup.timer --no-pager || true
}

# Install as user service (fallback)
install_user_service() {
    log INFO "Installing systemd timer as user service..."

    # Create user systemd directory
    mkdir -p "${SYSTEMD_USER_DIR}"

    # Copy service and timer files
    cp "${PROJECT_ROOT}/systemd/rps-backup.service" "${SYSTEMD_USER_DIR}/"
    cp "${PROJECT_ROOT}/systemd/rps-backup.timer" "${SYSTEMD_USER_DIR}/"

    # Reload systemd user services
    systemctl --user daemon-reload

    # Enable and start timer
    systemctl --user enable rps-backup.timer
    systemctl --user start rps-backup.timer

    # Enable lingering (allows user services to run when not logged in)
    if command -v loginctl &> /dev/null; then
        loginctl enable-linger "$USER" 2>/dev/null || true
    fi

    log SUCCESS "User timer installed and started"

    # Show status
    echo ""
    systemctl --user status rps-backup.timer --no-pager || true
}

# Main installation
main() {
    echo ""
    log INFO "=== RPS Backup Timer Setup ==="
    echo ""

    # Check for systemd
    if ! command -v systemctl &> /dev/null; then
        log ERROR "systemd not found. This script requires systemd."
        exit 1
    fi

    # Check privileges
    check_privileges

    # Install based on type
    if [[ "$INSTALL_TYPE" == "system" ]]; then
        install_system_service
    else
        install_user_service
    fi

    echo ""
    log SUCCESS "=== Installation Complete ==="
    echo ""
    log INFO "The backup timer is now active and will run daily at 2:00 AM"
    log INFO "Backups will be stored in: ${PROJECT_ROOT}/backups"
    log INFO "Logs will be written to: ${PROJECT_ROOT}/logs/backup.log"
    echo ""
    log INFO "Useful commands:"
    if [[ "$INSTALL_TYPE" == "system" ]]; then
        log INFO "  Check timer status:    sudo systemctl status rps-backup.timer"
        log INFO "  View timer schedule:   sudo systemctl list-timers rps-backup.timer"
        log INFO "  Run backup manually:   sudo systemctl start rps-backup.service"
        log INFO "  View backup logs:      sudo journalctl -u rps-backup.service"
        log INFO "  Stop timer:            sudo systemctl stop rps-backup.timer"
        log INFO "  Disable timer:         sudo systemctl disable rps-backup.timer"
    else
        log INFO "  Check timer status:    systemctl --user status rps-backup.timer"
        log INFO "  View timer schedule:   systemctl --user list-timers rps-backup.timer"
        log INFO "  Run backup manually:   systemctl --user start rps-backup.service"
        log INFO "  View backup logs:      journalctl --user -u rps-backup.service"
        log INFO "  Stop timer:            systemctl --user stop rps-backup.timer"
        log INFO "  Disable timer:         systemctl --user disable rps-backup.timer"
    fi
    echo ""
    log INFO "You can also run backups manually with: ${PROJECT_ROOT}/bin/backup"
    echo ""
}

main
