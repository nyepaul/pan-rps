#!/bin/bash
###############################################################################
# RPS Incremental Backup Script
#
# Lightweight backup for data-only changes (database, configs, logs).
# Use for frequent automated backups between full system backups.
#
# Usage:
#   ./bin/backup-incremental              # Quick data backup
#   ./bin/backup-incremental --keep 30    # Keep last 30 backups
#
# Author: pan
# Date: 2026-01-28
###############################################################################

set -euo pipefail

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
BACKUP_DIR="${PROJECT_ROOT}/backups/incremental"
LOG_DIR="${PROJECT_ROOT}/logs"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_NAME="rps_incremental_${TIMESTAMP}"
TEMP_DIR="/tmp/${BACKUP_NAME}"

# Default settings
KEEP_BACKUPS=30  # Keep last 30 incremental backups by default
VERIFY_BACKUP=true
VERBOSE=false

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --keep)
            KEEP_BACKUPS="$2"
            shift 2
            ;;
        --no-verify)
            VERIFY_BACKUP=false
            shift
            ;;
        --verbose|-v)
            VERBOSE=true
            shift
            ;;
        --help|-h)
            echo "Usage: $0 [options]"
            echo ""
            echo "Incremental backup - backs up data only (database, configs, logs)"
            echo ""
            echo "Options:"
            echo "  --keep N          Keep last N backups (default: 30)"
            echo "  --no-verify       Skip backup verification"
            echo "  --verbose, -v     Verbose output"
            echo "  --help, -h        Show this help"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# Logging function
log() {
    local level=$1
    shift
    local message="$*"
    local timestamp=$(date +"%Y-%m-%d %H:%M:%S")

    # Create log directory if it doesn't exist
    mkdir -p "${LOG_DIR}"

    # Log to file
    echo "[${timestamp}] [${level}] ${message}" >> "${LOG_DIR}/backup.log"

    # Log to console with colors
    case $level in
        INFO)
            echo -e "${BLUE}[INFO]${NC} ${message}"
            ;;
        SUCCESS)
            echo -e "${GREEN}[SUCCESS]${NC} ${message}"
            ;;
        WARNING)
            echo -e "${YELLOW}[WARNING]${NC} ${message}"
            ;;
        ERROR)
            echo -e "${RED}[ERROR]${NC} ${message}"
            ;;
        *)
            echo "[${level}] ${message}"
            ;;
    esac
}

# Error handler
error_exit() {
    log ERROR "$1"
    # Cleanup temp directory
    if [[ -d "${TEMP_DIR}" ]]; then
        rm -rf "${TEMP_DIR}"
    fi
    exit 1
}

# Trap errors
trap 'error_exit "Backup failed at line $LINENO"' ERR

# Main backup function
main() {
    log INFO "Starting RPS incremental backup: ${BACKUP_NAME}"

    # Create backup directories
    mkdir -p "${BACKUP_DIR}"
    mkdir -p "${TEMP_DIR}"

    # Create backup structure
    mkdir -p "${TEMP_DIR}/data"
    mkdir -p "${TEMP_DIR}/config"
    mkdir -p "${TEMP_DIR}/logs"

    # Backup database
    log INFO "Backing up database..."
    if [[ -f "${PROJECT_ROOT}/data/planning.db" ]]; then
        # Use SQLite's backup command for hot backup
        sqlite3 "${PROJECT_ROOT}/data/planning.db" ".backup '${TEMP_DIR}/data/planning.db'"

        # Verify database integrity
        if [[ "${VERIFY_BACKUP}" == "true" ]]; then
            log INFO "Verifying database integrity..."
            sqlite3 "${TEMP_DIR}/data/planning.db" "PRAGMA integrity_check;" > /tmp/integrity_check.txt
            if grep -q "ok" /tmp/integrity_check.txt; then
                log SUCCESS "Database integrity verified"
            else
                error_exit "Database integrity check failed"
            fi
            rm /tmp/integrity_check.txt
        fi

        # Get database stats
        local db_size=$(du -h "${TEMP_DIR}/data/planning.db" | cut -f1)
        log INFO "Database size: ${db_size}"
    else
        log WARNING "Database not found at ${PROJECT_ROOT}/data/planning.db"
    fi

    # Backup configuration files
    log INFO "Backing up configuration files..."
    [[ -f "${PROJECT_ROOT}/.env" ]] && cp "${PROJECT_ROOT}/.env" "${TEMP_DIR}/config/" || true
    [[ -f "${PROJECT_ROOT}/.env.production" ]] && cp "${PROJECT_ROOT}/.env.production" "${TEMP_DIR}/config/" || true
    [[ -f "${PROJECT_ROOT}/config/alembic.ini" ]] && cp "${PROJECT_ROOT}/config/alembic.ini" "${TEMP_DIR}/config/" || true

    # Backup version info to track what version the data came from
    if [[ -f "${PROJECT_ROOT}/src/static/version.json" ]]; then
        cp "${PROJECT_ROOT}/src/static/version.json" "${TEMP_DIR}/config/"
    fi

    # Backup recent logs (last 24 hours only for incremental)
    log INFO "Backing up recent logs..."
    if [[ -d "${PROJECT_ROOT}/logs" ]]; then
        find "${PROJECT_ROOT}/logs" -type f -mtime -1 -exec cp {} "${TEMP_DIR}/logs/" \; 2>/dev/null || true
    fi

    # Create backup metadata
    cat > "${TEMP_DIR}/backup_metadata.txt" << EOF
Backup Name: ${BACKUP_NAME}
Backup Type: INCREMENTAL (Data Only)
Timestamp: $(date)
Hostname: $(hostname)
User: $(whoami)
RPS Version: $(python3 -c "import json; print(json.load(open('${PROJECT_ROOT}/src/static/version.json'))['version'])" 2>/dev/null || echo "unknown")
Backup Script: $0

=== Backup Contents ===
Database Size: $(du -h "${TEMP_DIR}/data/planning.db" 2>/dev/null | cut -f1 || echo "N/A")
Database Tables: $(sqlite3 "${TEMP_DIR}/data/planning.db" "SELECT COUNT(*) FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%';" 2>/dev/null || echo "N/A")
Config Files: $(find "${TEMP_DIR}/config" -type f 2>/dev/null | wc -l || echo "N/A")
Log Files: $(find "${TEMP_DIR}/logs" -type f 2>/dev/null | wc -l || echo "N/A")

Total Backup Size: $(du -sh "${TEMP_DIR}" | cut -f1)

Note: This is an incremental backup containing only data files.
For full system restore, use a full system backup from ./bin/backup
EOF

    # Create compressed archive with optimal compression
    log INFO "Creating compressed archive (optimal compression)..."
    cd "${BACKUP_DIR}"
    # Use maximum gzip compression (-9) for optimal space savings
    tar -c -C /tmp "${BACKUP_NAME}" | gzip -9 > "${BACKUP_NAME}.tar.gz"

    # Verify archive
    if [[ "${VERIFY_BACKUP}" == "true" ]]; then
        log INFO "Verifying archive integrity..."
        if tar -tzf "${BACKUP_NAME}.tar.gz" > /dev/null 2>&1; then
            log SUCCESS "Archive integrity verified"
        else
            error_exit "Archive verification failed"
        fi
    fi

    # Get final backup size
    local backup_size=$(du -h "${BACKUP_DIR}/${BACKUP_NAME}.tar.gz" | cut -f1)
    log SUCCESS "Incremental backup created: ${BACKUP_NAME}.tar.gz (${backup_size})"

    # Cleanup temp directory
    rm -rf "${TEMP_DIR}"

    # Rotate old backups
    log INFO "Rotating old backups (keeping last ${KEEP_BACKUPS})..."
    cd "${BACKUP_DIR}"
    ls -t rps_incremental_*.tar.gz 2>/dev/null | tail -n +$((KEEP_BACKUPS + 1)) | while read old_backup; do
        log INFO "Removing old backup: ${old_backup}"
        rm -f "${old_backup}"
    done

    # Count remaining backups
    local backup_count=$(ls -1 rps_incremental_*.tar.gz 2>/dev/null | wc -l)
    log INFO "Total incremental backups: ${backup_count}"

    # Print summary
    echo ""
    log SUCCESS "=== Incremental Backup Summary ==="
    log INFO "Backup file: ${BACKUP_DIR}/${BACKUP_NAME}.tar.gz"
    log INFO "Size: ${backup_size}"
    log INFO "Backups retained: ${backup_count}"
    log INFO "Log file: ${LOG_DIR}/backup.log"
    echo ""
}

# Run main function
main

exit 0
